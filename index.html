<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒ¸ æ¯æ—¥ç¥ç¦ Blessing of the Day / Berkat Harian ğŸŒ¸</title>
  <style>
    /* your original CSS here (unchanged) */
  </style>
</head>
<body>
  <!-- your HTML body (unchanged) -->

  <audio id="bgm" autoplay loop muted playsinline>
    <source src="gentle-piano.mp3" type="audio/mpeg">
  </audio>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const drawBtn = document.getElementById('draw-btn');
      const shareBtn = document.getElementById('share-btn');
      const musicBtn = document.getElementById('music-btn');
      const card = document.getElementById('blessing-card');
      const cardCover = document.getElementById('card-cover');
      const blessingContent = document.getElementById('blessing-content');
      const bgm = document.getElementById('bgm');

      let blessings = [];
      let currentBlessing = null;
      let audioPlaying = true;
      let lastIndex = -1;
      let usedIndices = [];

      const FALLBACK = [
        {
          "zh": "è€¶å’Œåæ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å¿…ä¸è‡´ç¼ºä¹ã€‚",
          "en": "The Lord is my shepherd; I shall not want.",
          "ms": "Tuhan ialah gembalaku, aku tidak kekurangan apa-apa.",
          "ref": "è¯—ç¯‡ Psalm 23:1"
        },
        {
          "zh": "ä½ è¦ä¸“å¿ƒä»°èµ–è€¶å’Œåï¼Œä¸å¯å€šé è‡ªå·±çš„èªæ˜ã€‚",
          "en": "Trust in the Lord with all your heart and lean not on your own understanding.",
          "ms": "Percayalah kepada Tuhan dengan segenap hatimu dan janganlah bersandar kepada pengertianmu sendiri.",
          "ref": "ç®´è¨€ Proverbs 3:5"
        },
        {
          "zh": "å‡¡ä½ ä»¬æ‰€åšçš„ï¼Œéƒ½è¦å‡­çˆ±å¿ƒè€Œåšã€‚",
          "en": "Do everything in love.",
          "ms": "Lakukan segala sesuatu dengan kasih.",
          "ref": "å“¥æ—å¤šå‰ä¹¦ 1 Corinthians 16:14"
        }
      ];

      function getSecureRandom(max) {
        const array = new Uint32Array(1);
        crypto.getRandomValues(array);
        return array[0] % max;
      }

      function getRandomBlessing() {
        if (blessings.length === 0) return null;
        if (usedIndices.length >= Math.floor(blessings.length * 0.7)) {
          usedIndices = [];
        }
        let availableIndices = [];
        for (let i = 0; i < blessings.length; i++) {
          if (!usedIndices.includes(i) && i !== lastIndex) {
            availableIndices.push(i);
          }
        }
        if (availableIndices.length === 0) {
          availableIndices = Array.from({length: blessings.length}, (_, i) => i);
        }
        const randomPosition = getSecureRandom(availableIndices.length);
        const selectedIndex = availableIndices[randomPosition];
        lastIndex = selectedIndex;
        usedIndices.push(selectedIndex);
        return blessings[selectedIndex];
      }

      function renderBlessing(item) {
        if (!item) return;
        currentBlessing = item;
        blessingContent.innerHTML = `
          <div class="text-block">
            <p class="chinese">${item.zh}</p>
            <p class="english">${item.en}</p>
            <p class="malay">${item.ms}</p>
          </div>
          <div class="reference">ğŸ“– ${item.ref || ''}</div>
          <div class="footer-text">ğŸ’ æ„¿ä¸»ç¥ç¦ä½  ğŸ’</div>
        `;
        cardCover.style.display = 'none';
        blessingContent.classList.add('show');
        card.classList.add('has-blessing');
      }

      function drawRandom() {
        if (!Array.isArray(blessings) || blessings.length === 0) {
          alert('ç¥ç¦è¯­è½½å…¥ä¸­ï¼Œè¯·ç¨åå†è¯• / Loading blessings, please try again');
          return;
        }
        const blessing = getRandomBlessing();
        renderBlessing(blessing);
      }

      function shareCurrent() {
        if (!currentBlessing) {
          alert('è¯·å…ˆæŠ½å–ç¥ç¦ / Please draw a blessing first / Sila dapatkan berkat dahulu');
          return;
        }
        const text = `ğŸŒ¸ æ¯æ—¥ç¥ç¦ Daily Blessing ğŸŒ¸\n\n${currentBlessing.zh}\n\n${currentBlessing.en}\n\n${currentBlessing.ms}\n\nğŸ“– ${currentBlessing.ref || ''}\n\nğŸ’ æ„¿ä¸»ç¥ç¦ä½  ğŸ’`;
        const url = window.location.href;
        if (navigator.share) {
          navigator.share({ title: 'æ¯æ—¥ç¥ç¦ | Blessing of the Day', text, url }).catch(()=>{});
        } else {
          const encoded = encodeURIComponent(`${text}\n\n${url}`);
          window.open(`https://wa.me/?text=${encoded}`, '_blank');
        }
      }

      function updateMusicBtn() {
        if (!musicBtn) return;
        musicBtn.textContent = audioPlaying
          ? 'ğŸµ æš‚åœéŸ³ä¹ | Pause Music | Hentikan Muzik'
          : 'ğŸµ æ’­æ”¾éŸ³ä¹ | Play Music | Main Muzik';
      }

      function tryAutoPlay() {
        if (!bgm) return;
        bgm.volume = 0.28;
        bgm.play().then(() => {
          audioPlaying = true;
          updateMusicBtn();
        }).catch(() => {
          audioPlaying = false;
          updateMusicBtn();
        });
      }

      if (drawBtn) drawBtn.addEventListener('click', drawRandom);
      if (shareBtn) shareBtn.addEventListener('click', shareCurrent);
      if (musicBtn && bgm) {
        musicBtn.addEventListener('click', () => {
          if (audioPlaying) {
            bgm.pause();
            audioPlaying = false;
          } else {
            bgm.play().catch(()=>{});
            audioPlaying = true;
          }
          updateMusicBtn();
        });
      }

      // âœ… Modified fetch logic (auto fallback for GitHub Pages)
      fetch('blessings.json')
        .then(resp => {
          if (!resp.ok) throw new Error('load failed');
          return resp.json();
        })
        .then(data => {
          if (!Array.isArray(data) || data.length === 0) throw new Error('invalid json');
          blessings = data;
          console.log(`âœ… Loaded ${data.length} blessings from blessings.json`);
        })
        .catch(err => {
          console.warn('âš ï¸ blessings.json failed to load, trying script fallback...', err);
          const script = document.createElement('script');
          script.src = 'blessings.js'; // optional backup
          script.onload = () => {
            if (window.BLESSINGS_DATA && Array.isArray(window.BLESSINGS_DATA)) {
              blessings = window.BLESSINGS_DATA;
              console.log(`âœ… Loaded ${blessings.length} blessings from blessings.js`);
            } else {
              blessings = FALLBACK.slice();
              console.warn('âš ï¸ blessings.js not found, using fallback list.');
            }
          };
          script.onerror = () => {
            blessings = FALLBACK.slice();
            console.warn('âš ï¸ All loading failed â€” using fallback.');
          };
          document.body.appendChild(script);
        })
        .finally(() => {
          tryAutoPlay();
          updateMusicBtn();
        });
    });
  </script>
</body>
</html>
