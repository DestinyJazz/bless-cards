<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🌸 每日祝福 Blessing of the Day / Berkat Harian 🌸</title>
  <style>
    body {
      margin: 0;
      font-family: "Noto Sans SC", "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1em;
    }
    .container {
      text-align: center;
      background: rgba(255, 255, 255, 0.95);
      padding: 2.5em 2em;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
    }
    h1 {
      font-size: 1.4em;
      margin-bottom: 1.5em;
      color: #333;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    .card {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      border: 3px solid #fff;
      border-radius: 16px;
      padding: 2em 1.5em;
      margin-bottom: 1.5em;
      min-height: 200px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      transition: all 0.4s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .card.has-blessing {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    }
    
    .card-cover {
      text-align: center;
    }
    
    .card-cover .ornament {
      font-size: 3.5em;
      margin-bottom: 0.3em;
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    .card-cover h2 {
      font-size: 1.5em;
      color: #8B4513;
      margin: 0.5em 0;
      font-weight: 600;
    }
    
    .card-cover p {
      font-size: 0.95em;
      color: #666;
      margin: 0.6em 0;
      line-height: 1.5;
    }
    
    .card-cover .hint {
      font-size: 0.85em;
      color: #999;
      margin-top: 1em;
      font-style: italic;
    }
    
    .blessing-content {
      text-align: center;
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    .blessing-content.show {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .blessing-content p {
      margin: 0.7em 0;
      line-height: 1.7;
      font-size: 1em;
    }
    
    .blessing-content .chinese {
      font-size: 1.2em;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .blessing-content .english {
      font-style: italic;
      color: #34495e;
      font-size: 0.95em;
    }
    
    .blessing-content .malay {
      color: #34495e;
      font-size: 0.95em;
    }
    
    .blessing-content .reference {
      font-size: 0.85em;
      color: #7f8c8d;
      margin-top: 1em;
      padding-top: 1em;
      border-top: 1px solid rgba(0,0,0,0.1);
    }
    
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 0.8em;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 12px 24px;
      font-size: 1em;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    #draw-btn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
    }
    
    #draw-btn:hover {
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
    }
    
    @media (max-width: 600px) {
      .container {
        padding: 1.5em;
      }
      h1 {
        font-size: 1.1em;
      }
      .card {
        padding: 1.5em 1em;
        min-height: 180px;
      }
      .card-cover h2 {
        font-size: 1.3em;
      }
      button {
        font-size: 0.9em;
        padding: 10px 18px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🌸 每日祝福 | Blessing of the Day | Berkat Harian 🌸</h1>
    
    <div id="blessing-card" class="card">
      <!-- Cover (shown by default) -->
      <div class="card-cover" id="card-cover">
        <div class="ornament">✨</div>
        <h2>今日的祝福</h2>
        <p><strong>Today's Blessing</strong></p>
        <p><strong>Berkat Hari Ini</strong></p>
        <div class="hint">👇 点击下方按钮获取祝福 👇</div>
      </div>
      
      <!-- Blessing content (hidden initially) -->
      <div class="blessing-content" id="blessing-content">
        <p class="chinese">点击"抽取祝福"开始</p>
        <p class="english">Click "Get Blessing" to start</p>
        <p class="malay">Klik "Dapatkan Berkat" untuk mula</p>
      </div>
    </div>
    
    <div class="button-group">
      <button id="draw-btn">抽取祝福 | Get Blessing | Dapatkan Berkat</button>
      <button id="share-btn">分享祝福 | Share Blessing | Kongsi Berkat</button>
      <button id="music-btn">暂停音乐 | Pause Music | Hentikan Muzik</button>
    </div>
  </div>
  
  <audio id="bgm" autoplay loop>
    <source src="https://cdn.freesound.org/previews/367/367053_5121236-lq.mp3" type="audio/mpeg">
  </audio>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const drawBtn = document.getElementById('draw-btn');
      const shareBtn = document.getElementById('share-btn');
      const musicBtn = document.getElementById('music-btn');
      const card = document.getElementById('blessing-card');
      const cardCover = document.getElementById('card-cover');
      const blessingContent = document.getElementById('blessing-content');
      const bgm = document.getElementById('bgm');

      let blessings = [];
      let currentBlessing = null;
      let audioPlaying = true;
      let lastIndex = -1;
      let usedIndices = [];

      const FALLBACK = [
        {
          "zh": "耶和华是我的牧者，我必不致缺乏。",
          "en": "The Lord is my shepherd; I shall not want.",
          "ms": "Tuhan ialah gembalaku, aku tidak kekurangan apa-apa.",
          "ref": "诗篇 Psalm 23:1"
        },
        {
          "zh": "你要专心仰赖耶和华，不可倚靠自己的聪明。",
          "en": "Trust in the Lord with all your heart and lean not on your own understanding.",
          "ms": "Percayalah kepada Tuhan dengan segenap hatimu dan janganlah bersandar kepada pengertianmu sendiri.",
          "ref": "箴言 Proverbs 3:5"
        },
        {
          "zh": "凡你们所做的，都要凭爱心而做。",
          "en": "Do everything in love.",
          "ms": "Lakukan segala sesuatu dengan kasih.",
          "ref": "哥林多前书 1 Corinthians 16:14"
        }
      ];

      function getSecureRandom(max) {
        const array = new Uint32Array(1);
        crypto.getRandomValues(array);
        return array[0] % max;
      }

      function getRandomBlessing() {
        if (blessings.length === 0) return null;
        
        if (usedIndices.length >= Math.floor(blessings.length * 0.7)) {
          usedIndices = [];
        }
        
        let availableIndices = [];
        for (let i = 0; i < blessings.length; i++) {
          if (!usedIndices.includes(i) && i !== lastIndex) {
            availableIndices.push(i);
          }
        }
        
        if (availableIndices.length === 0) {
          availableIndices = Array.from({length: blessings.length}, (_, i) => i);
        }
        
        const randomPosition = getSecureRandom(availableIndices.length);
        const selectedIndex = availableIndices[randomPosition];
        
        lastIndex = selectedIndex;
        usedIndices.push(selectedIndex);
        
        return blessings[selectedIndex];
      }

      function renderBlessing(item) {
        if (!item) return;
        currentBlessing = item;
        
        blessingContent.innerHTML = `
          <p class="chinese">${item.zh}</p>
          <p class="english">${item.en}</p>
          <p class="malay">${item.ms}</p>
          <div class="reference">📖 ${item.ref || ''}</div>
        `;
        
        // Hide cover, show blessing
        cardCover.style.display = 'none';
        blessingContent.classList.add('show');
        card.classList.add('has-blessing');
      }

      function drawRandom() {
        if (!Array.isArray(blessings) || blessings.length === 0) {
          alert('祝福语载入中，请稍后再试 / Loading blessings, please try again');
          return;
        }
        
        const blessing = getRandomBlessing();
        renderBlessing(blessing);
      }

      function shareCurrent() {
        if (!currentBlessing) {
          alert('请先抽取祝福 / Please draw a blessing first / Sila dapatkan berkat dahulu');
          return;
        }
        const text = `🌸 ${currentBlessing.zh}\n\n${currentBlessing.en}\n\n${currentBlessing.ms}\n\n📖 ${currentBlessing.ref || ''}`;
        const url = window.location.href;

        if (navigator.share) {
          navigator.share({
            title: '每日祝福 | Blessing of the Day',
            text,
            url
          }).catch(()=>{});
        } else {
          const encoded = encodeURIComponent(`${text}\n${url}`);
          const wa = `https://wa.me/?text=${encoded}`;
          window.open(wa, '_blank');
        }
      }

      function updateMusicBtn() {
        if (!musicBtn) return;
        musicBtn.textContent = audioPlaying
          ? '暂停音乐 | Pause Music | Hentikan Muzik'
          : '播放音乐 | Play Music | Main Muzik';
      }

      function tryAutoPlay() {
        if (!bgm) return;
        bgm.volume = 0.28;
        bgm.play()
          .then(() => { audioPlaying = true; updateMusicBtn(); })
          .catch(() => { audioPlaying = false; updateMusicBtn(); });
      }

      if (drawBtn) drawBtn.addEventListener('click', drawRandom);
      if (shareBtn) shareBtn.addEventListener('click', shareCurrent);
      if (musicBtn && bgm) {
        musicBtn.addEventListener('click', () => {
          if (audioPlaying) {
            bgm.pause();
            audioPlaying = false;
          } else {
            bgm.play().catch(()=>{});
            audioPlaying = true;
          }
          updateMusicBtn();
        });
      }

      fetch('blessings.json')
        .then(resp => {
          if (!resp.ok) throw new Error('load failed');
          return resp.json();
        })
        .then(data => {
          if (!Array.isArray(data) || data.length === 0) throw new Error('invalid json');
          blessings = data;
        })
        .catch(err => {
          console.warn('Failed to load blessings.json — using fallback. Error:', err);
          blessings = FALLBACK.slice();
        })
        .finally(() => {
          tryAutoPlay();
          updateMusicBtn();
        });
    });
  </script>
</body>
</html>
